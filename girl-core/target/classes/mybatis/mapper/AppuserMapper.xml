<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AppuserMapper">
	<!-- 更新登录时间 -->
	<update id="updateLastLogin" parameterType="pd">
		update 
			sys_app_user 
		set 
			last_login = #{last_login},
			ip = #{ip} 
		where 
			user_id = #{user_id}
	</update>
	
	<!-- 判断用户名和密码 -->
	<select id="getUserInfo" parameterType="pd" resultType="pd">
		select * from sys_app_user 
			where 1=1
		<if test="username != null and password != null">
	  	and	
	  		(
	  		("username" = #{username} and "password" = #{password})
	  		or
	  		("email" = #{username} and "password" = #{password})
	  		or
	  		("number" = #{username} and "password" = #{password})
	  		)
	  		or
	  		("phone" = #{phone} and "password" = #{password})
	  		)
		</if>
		<if test="user_id != null and user_id != ''">
			and user_id = #{user_id}
		</if>
	</select>
	
	<!-- 存入IP -->
	<update id="saveIP" parameterType="pd">
		update sys_app_user 
			set 
				ip = #{ip}
			where 
				username = #{username}
	</update>
	
	<!-- 修改 -->
	<update id="editU" parameterType="pd">
		update  sys_app_user
			set username				= #{username},
				name					= #{name},
				role_id 				= #{role_id},
				bz						= #{bz},
				phone 					= #{phone},
				sfid 					= #{sfid},
				start_time	 			= #{start_time},
				end_time 				= #{end_time},
				years					= #{years},
				status 					= #{status},
				email					= #{email},
				number 					= #{number}
			<if test="password != null and password != ''">
				,password				= #{password}
			</if>
            <if test="nim_token != null and nim_token != ''">
                ,nim_token				= #{nim_token}
            </if>
			where 
				user_id = #{user_id}
	</update>
	
	
	<update id="editUD" parameterType="pd">
		update  sys_app_user
			set 
				username = #{username},
				usernick = #{usernick},
				sex	= #{sex}
			where 
				user_id = #{user_id}
	</update>
	
	
	<update id="editUH" parameterType="pd">
		update  sys_app_user
			set 
				headImgUrl = #{headImgUrl}
			where 
				user_id = #{user_id}
	</update>
	
	<update id="editCD" parameterType="pd">
		update  sys_app_user
			set 
				username = #{username},
				img_src_z = #{img_src_z},
				img_src_f = #{img_src_f},
				if_audit = #{if_audit}
			where 
				user_id = #{user_id}
	</update>
	
	<update id="editAudit" parameterType="pd">
		update  sys_app_user
			set 
				if_audit = #{if_audit}
			where 
				user_id = #{user_id}
	</update>
	
	<!-- 只加积分 -->
	<update id="editIntegral" parameterType="pd">
		update  sys_app_user
			set
				integral = integral + ${integral}
		where 
			user_id = #{user_id}
	</update>
	
	<!-- 只减积分 -->
	<update id="cutIntegral" parameterType="pd">
		update  sys_app_user
			set
				integral = integral - ${integral}
		where 
			user_id = #{user_id}
	</update>
	
	<!-- 修改密码 -->
	<update id="editP" parameterType="pd">
		update  sys_app_user
			set password = #{password}
			where 
				user_id = #{user_id}
	</update>
	
	<!-- 通过user_id获取数据 -->
	<select id="findByUiId" parameterType="pd" resultType="pd">
		select 
			account,
			user_id,
			username,
			usernick,
			password,
			name,
			rights,
			role_id,
			last_login,
			ip,
			status,
			bz,
			phone,
			sfid,
			start_time,
			end_time,
			years, 
			email,
			number,
			integral,
			usernick,
			sex,
			headImgUrl,	
			weixin_open_id,
			img_src_z,
			img_src_f,
			if_audit,
			nim_token,
			community_id
		from 
			sys_app_user
		where 
			user_id = #{user_id}
	</select>
	
	<!-- 通过邮箱获取数据 -->
	<select id="findByUE" parameterType="pd" resultType="pd">
		select 
			user_id,
			username,
			password,
			name,
			rights,
			role_id,
			last_login,
			ip,
			status,
			bz,
			phone,
			sfid,
			start_time,
			end_time,
			years,
			email,
			usernick,
			sex,
			number,
			img_src_z,
			img_src_f,
			nim_token,
			if_audit
		from 
			sys_app_user
		where 
			email = #{email}
		<if test="username != null and username != ''">
			and username != #{username} 
		</if>
	</select>
	
	<!-- 通过编号获取数据 -->
	<select id="findByUN" parameterType="pd" resultType="pd">
		select 
			user_id,
			username,
			password,
			name,
			rights,
			role_id,
			last_login,
			ip,
			status,
			bz,
			phone,
			sfid,
			start_time,
			end_time,
			years,
			email,
			usernick,
			sex,
			nim_token,
			number
		from 
			sys_app_user
		where 
			number = #{number}
		<if test="username != null and username != ''">
			and username != #{username} 
		</if>
	</select>
	
	<!-- 通过USERNAME获取数据 -->
	<select id="findByUId" parameterType="pd" resultType="pd">
		select 
			account,
			user_id,
			username,
			password,
			name,
			rights,
			role_id,
			last_login,
			ip,
			status,
			bz,
			phone,
			sfid,
			start_time,
			end_time,
			years,
			email,
			usernick,
			sex,
			number,
			nim_token,
			img_src_z,
			img_src_f,
			if_audit
		from 
			sys_app_user
		where 
			username = #{username}
	</select>
	
	<!-- 通过account获取数据 -->
	<select id="findByAC" parameterType="pd" resultType="pd">
		select 
			user_id,
			username,
			password,
			name,
			rights,
			role_id,
			last_login,
			ip,
			status,
			bz,
			phone,
			sfid,
			start_time,
			end_time,
			years,
			email,
			usernick,
			sex,
			number,
			img_src_z,
			img_src_f,
			nim_token,
			if_audit
		from 
			sys_app_user
		where 
			(phone = #{account} or account = #{account}) and community_id = #{community_id}
	</select>
	
	<!-- 通过account获取数据 -->
	<select id="findByACUser" parameterType="pd" resultType="com.yf.core.system.entiy.system.AppUser">
		select 
			user_id,
			username,
			password,
			name,
			rights,
			role_id,
			last_login,
			ip,
			status,
			bz,
			phone,
			sfid,
			start_time,
			end_time,
			years,
			email,
			number,
			integral,
			usernick,
			sex,
			weixin_open_id,
			headImgUrl,
			img_src_z,
			img_src_f,
			if_audit,
			community_id,
			nim_token,
			is_lawyer
		from 
			sys_app_user
		where 
			(phone = #{account} or account = #{account}) and community_id = #{community_id}
	</select>
	
	<!-- 通过手机号码获取数据 -->
	<select id="getUserByPhone" parameterType="pd" resultType="com.yf.core.system.entiy.system.AppUser">
		select 
			user_id,
			username,
			password,
			name,
			rights,
			role_id,
			last_login,
			ip,
			status,
			bz,
			phone,
			sfid,
			start_time,
			end_time,
			years,
			email,
			number,
			weixin_open_id,
			reading_protocol,
			integral,
			usernick,
			sex,
			weixin_open_id,
			headImgUrl,
			img_src_z,
			img_src_f,
			if_audit,
			community_id,
			nim_token,
			is_lawyer
		from 
			sys_app_user
		where 
			phone = #{account} and community_id = #{community_id}
	</select>
	
	<!-- 新增app用户 -->
	<insert id="saveU" parameterType="pd">
		insert into sys_app_user (
			account,
			user_id,
			username,
			password,
			name,
			rights,
			role_id,
			last_login,
			ip,
			status,
			bz,
			phone,
			sfid,
			start_time,
			end_time,
			years,
			email,
			usernick,
			sex,
			weixin_open_id,
			headImgUrl,
			if_audit,
			number
		) values (
			#{account},
			#{user_id},
			#{username},
			#{password},
			#{name},
			#{rights},
			#{role_id},
			#{last_login},
			#{ip},
			#{status},
			#{bz},
			#{phone},
			#{sfid},
			#{start_time},
			#{end_time},
			#{years},
			#{email},
			#{usernick},
			#{sex},
			#{weixin_open_id},
			#{headImgUrl},
			0,
			#{number}
		)
	</insert>
	
	<insert id="saveAppUser" parameterType="com.yf.core.system.entiy.system.AppUser">
		insert into sys_app_user (
			integral,
			account,
			user_id,
			username,
			password,
			name,
			rights,
			role_id,
			last_login,
			ip,
			status,
			bz,
			phone,
			sfid,
			start_time,
			end_time,
			years,
			email,
			community_id,
			number,
			sex,
			usernick,
			weixin_open_id,
			if_audit,
			headImgUrl
			<if test="is_lawyer != null">,is_lawyer</if> 
		) values (
			#{integral},
			#{account},
			#{user_id},
			#{username},
			#{password},
			#{name},
			#{rights},
			#{role_id},
			NOW(),
			#{ip},
			'1',
			#{bz},
			#{phone},
			#{sfid},
			#{start_time},
			#{end_time},
			#{years},
			#{email},
			#{community_id},
			#{number},
			0,
			#{usernick},
			#{weixin_open_id},
			0,
			#{headImgUrl}
			<if test="is_lawyer != null">,#{is_lawyer}</if> 
		)
	</insert>
	
	<!-- 用户列表(app用户组) -->
	<select id="userlistPage" parameterType="page" resultType="pd">
		select  u.user_id,
				u.username,
				u.usernick,
				u.sex,
				u.password,
				u.last_login,
				u.name,
				u.ip,
				u.end_time,
				u.years,
				u.status,
				u.email,
				u.phone,
				u.number,
				u.integral,
				u.if_audit
		from sys_app_user u
		WHERE 1=1
		<if test="pd.username != null and pd.username != ''"><!-- 用户名检索 -->
			and (
				u.username like concat(concat('%', #{pd.username}),'%')
				or
				u.email like concat(concat('%', #{pd.username}),'%')
				or
				u.number like concat(concat('%', #{pd.username}),'%')
				)
		</if>
		<if test="pd.lastloginstart!=null and pd.lastloginstart!=''"><!-- 到期时间检索 -->
			and u.end_time &gt;= #{pd.lastloginstart} 
		</if>
		<if test="pd.lastloginend!=null and pd.lastloginend!=''"><!-- 到期时间检索 -->
			and u.end_time &lt;= #{pd.lastloginend} 
		</if>
		<if test="pd.status != null and pd.status != ''"><!-- 状态检索 -->
			and u.status=#{pd.status} 
		</if>
	</select>
	
	<!-- 用户列表(全部) -->
	<select id="listAllUser" parameterType="pd" resultType="pd">
		select  u.user_id,
				u.sex,
				u.usernick,
				u.username,
				u.password,
				u.last_login,
				u.name,
				u.ip,
				u.end_time,
				u.years,
				u.status,
				u.email,
				u.sfid,
				u.phone,
				u.number,
				r.ROLE_ID,
				r.ROLE_NAME
		from sys_app_user u, sys_role r 
		where u.role_id = r.ROLE_ID 
		and 1 = 1
		and r.PARENT_ID = '7'
		
		<if test="username != null and username != ''"><!-- 用户名检索 -->
			and (
				u.username like concat(concat('%', #{username}),'%')
				or
				u.email like concat(concat('%', #{username}),'%')
				or
				u.number like concat(concat('%', #{username}),'%')
				)
		</if>
		<if test="role_id != null and role_id != ''"><!-- 角色检索 -->
			and u.role_id=#{role_id} 
		</if>
		<if test="lastloginstart!=null and lastloginstart!=''"><!-- 到期时间检索 -->
			and u.end_time &gt;= #{lastloginstart} 
		</if>
		<if test="lastloginend!=null and lastloginend!=''"><!-- 到期时间检索 -->
			and u.end_time &lt;= #{lastloginend} 
		</if>
		<if test="status != null and status != ''"><!-- 状态检索 -->
			and u.status=#{status} 
		</if>
	</select>
	
	<!-- 删除用户 -->
	<delete id="deleteU" parameterType="pd">
		delete from sys_app_user 
		where 
			user_id = #{user_id}
	</delete>
	
	<!-- 批量删除用户 -->
	<delete id="deleteAllU" parameterType="String">
		delete from sys_app_user
		where 
			user_id in
  			 <foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                  #{item}
             </foreach>
	</delete>
	<!-- 查询 积分前10名 用户 -->
	<select id="findUserByIntegralTop" resultType="pd">
		SELECT u.username,u.integral from sys_app_user u where u.status = 1 order by  u.integral desc limit  10
	</select>
	
</mapper>